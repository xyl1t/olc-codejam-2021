### Makefile ###

# Usage: 
# make 		 -> build project in release mode
# make debug -> build project in debug mode
# make web   -> compile project for web
# make clean -> clean up build

# clang++ -arch x86_64 -std=c++17 main.cpp -Iinclude -Llib -framework OpenGL -framework GLUT -framework Carbon -lpng -lSDL2 -lSDL2_mixer -lsoloud_static -ldl -o game
# em++ -std=c++17 -O2 -s ALLOW_MEMORY_GROWTH=1 -s MAX_WEBGL_VERSION=2 -s MIN_WEBGL_VERSION=2 -s USE_LIBPNG=1 -s USE_SDL_MIXER=2 -Iinclude main.cpp soloud.o -o game.html --preload-file ./assets
# -lX11 -lGL -lpthread -lpng -lstdc++fs -std=c++17

### Variables ###
PROJECTNAME := game
SRCDIR := src
BUILDDIR := build
PROJECT := $(BUILDDIR)/$(PROJECTNAME)
SOURCES := $(wildcard $(SRCDIR)/*.cpp)
OBJS := $(patsubst $(SRCDIR)/%.cpp,$(BUILDDIR)/%.o,$(SOURCES))
# CXX := clang++
CXXFLAGS := -std=c++17 -Iinclude
LDFLAGS := -Llib
LDLIBS := -lX11 -lGL -lpthread -lpng -lstdc++fs -lsoloud_static -lbox2d -ldl
# Include dependencies
deps := $(patsubst %.o,%.d,$(OBJS))
-include $(deps)
DEPFLAGS = -MMD -MF $(@:.o=.d)

### Phony targets ###
.PHONY: all clean debug web
.DEFAULT_GOAL := all
all: CXXFLAGS := $(CXXFLAGS) -O2
all: $(PROJECT)
# .DEFAULT_GOAL := multi
# multi: 
# 	$(MAKE) -j8 all


debug: CXXFLAGS := -std=c++17 -Wall -Iinclude -DDEBUG -g -ggdb3
debug: $(PROJECT)

web: CXX := em++
web: CXXFLAGS := -std=c++17 -O2 -Iinclude
web: LDLIBS := -s ALLOW_MEMORY_GROWTH=1 -s MAX_WEBGL_VERSION=2 -s MIN_WEBGL_VERSION=2 -s USE_LIBPNG=1 -s USE_SDL_MIXER=2 --preload-file ./assets lib/soloud.o lib/box2d.o
web: PROJECT := $(BUILDDIR)/$(PROJECTNAME).html
web: $(PROJECT)

### Compilation ###
# Compile project
$(PROJECT) : $(OBJS)
	@echo Bulding $(PROJECT)
	$(CXX) $^ $(CXXFLAGS) $(LDFLAGS) $(LDLIBS) -o $(PROJECT)
	@echo $(PROJECT) built successfully

# Compile .o files
$(BUILDDIR)/%.o : $(SRCDIR)/%.cpp
	$(CXX) $(CXXFLAGS) $(DEPFLAGS) -c $< -o $@

# clean build
clean: 
	@rm -rf build/*
